import React, { useState } from "react";
import { Grid, Paper, Typography } from "@mui/material";

const cellStyle = {
    width: `${100 / 8}%`,
    aspectRatio: "1 / 1",
    textAlign: "center",
    fontSize: "18px",
    fontWeight: "bold",
    border: "1px solid #000",
    cursor: "pointer",
};
const BlackCircle = () => {
    const blackCircleStyle = {
        backgroundColor: "black",
        borderRadius: "50%",
        width: "80%",
        height: "80%",
        margin: "auto",
    };

    return <div style={blackCircleStyle}></div>;
};

const WhiteCircle = () => {
    const whiteCircleStyle = {
        backgroundColor: "white",
        borderRadius: "50%",
        width: "80%",
        height: "80%",
        margin: "auto",
    };

    return <div style={whiteCircleStyle}></div>;
};

export default function Reversi() {
    // Function to initialize the Reversi board and clicked cells
    function initializeBoard() {
        const board = Array(8)
            .fill(null)
            .map(() => Array(8).fill(null));

        // Set initial pieces
        board[3][3] = "W";
        board[3][4] = "B";
        board[4][3] = "B";
        board[4][4] = "W";

        // Initialize clicked cells with initial positions
        const clickedCells = [];
        clickedCells.push("3-3", "3-4", "4-3", "4-4");

        return { board, clickedCells };
    }

    const { board: initialBoard, clickedCells: initialClickedCells } = initializeBoard();
    const [board, setBoard] = useState(initialBoard);
    const [isBlackTurn, setIsBlackTurn] = useState(true);
    const [clickedCells, setClickedCells] = useState(initialClickedCells);

    // Function to handle a move
    const capturePieces = (row, col, newBoard) => {
        const currentPlayer = newBoard[row][col];
        const opponent = currentPlayer === "B" ? "W" : "B";

        const directions = [
            [-1, -1],
            [-1, 0],
            [-1, 1],
            [0, -1],
            [0, 1],
            [1, -1],
            [1, 0],
            [1, 1],
        ];

        for (const [dx, dy] of directions) {
            let x = row + dx;
            let y = col + dy;
            let foundOpponent = false;

            while (x >= 0 && x < 8 && y >= 0 && y < 8) {
                if (newBoard[x][y] === opponent) {
                    foundOpponent = true;
                } else if (newBoard[x][y] === currentPlayer && foundOpponent) {
                    // Flip opponent's pieces between (row, col) and (x, y)
                    let i = row + dx;
                    let j = col + dy;

                    while (i !== x || j !== y) {
                        newBoard[i][j] = currentPlayer;
                        i += dx;
                        j += dy;
                    }

                    break;
                } else {
                    break;
                }

                x += dx;
                y += dy;
            }
        }

        return newBoard;
    };

    // Function to handle a move
    const handleMove = (row, col) => {
        // Check if the move is valid according to Reversi rules
        if (isValidMove(row, col) && !cellIsClicked(row, col)) {
            // Implement the logic to update the board and capture pieces
            const newBoard = [...board];
            newBoard[row][col] = isBlackTurn ? "B" : "W";

            // Capture opponent's pieces
            const updatedBoard = capturePieces(row, col, newBoard);

            // Add the clicked cell to the list
            const newClickedCells = [...clickedCells];
            newClickedCells.push(`${row}-${col}`);
            setClickedCells(newClickedCells); // Update clickedCells with the new value

            // Update the board with the captured pieces
            setBoard(updatedBoard);

            // Change turns
            setIsBlackTurn(!isBlackTurn);
        }
    };

    const cellIsClicked = (row, col) => {
        return clickedCells.includes(`${row}-${col}`);
    };

    // Function to check if a move is valid
    const isValidMove = (row, col) => {
        // Implement your logic to check if the move is valid
        // It should consider the current player's color, adjacent opponent's pieces, and Reversi rules
        if (!board[row][col] && cellBorderedBySelectedPiece(row, col)) {
            return true;
        } else {
            return false;
        }
    };

    // Function to check if a cell is bordered by an already selected piece
    const cellBorderedBySelectedPiece = (row, col) => {
        // Check if any of the adjacent cells contain a selected piece
        const adjacentCells = [
            [row - 1, col - 1],
            [row - 1, col],
            [row - 1, col + 1],
            [row, col - 1],
            [row, col + 1],
            [row + 1, col - 1],
            [row + 1, col],
            [row + 1, col + 1],
        ];

        for (const [adjRow, adjCol] of adjacentCells) {
            if (isValidCoordinate(adjRow, adjCol) && cellIsClicked(adjRow, adjCol)) {
                return true;
            }
        }

        return false;
    };

    // Function to check if a coordinate is valid (within the board boundaries)
    const isValidCoordinate = (row, col) => {
        return row >= 0 && row < 8 && col >= 0 && col < 8;
    };

    const renderCellContent = (cell) => {
        if (cell === "B") {
            return <BlackCircle />;
        } else if (cell === "W") {
            return <WhiteCircle />;
        } else {
            return null; // Empty cell
        }
    };

    console.log("board", board);

    return (
        <div style={{ textAlign: "center", margin: "16px", width: "100%", marginTop: "6vh" }}>
            <Typography variant="h5" style={{ marginBottom: 24, marginTop: 12 }}>
                Reversi Game
            </Typography>
            <div className="turn" style={{ marginBottom: 12 }}>
                {isBlackTurn ? "Black" : "White"}'s Turn
            </div>

            <Grid
                container
                component={Paper}
                elevation={3}
                style={{
                    borderCollapse: "collapse",
                    width: "40%",
                    height: "fit",
                    margin: "0 auto",
                }}
            >
                <div className="board" style={{ width: "100%", backgroundColor: "#638EA0" }}>
                    {board.map((row, rowIndex) => (
                        <div
                            key={rowIndex}
                            className="row"
                            style={{ display: "flex", direction: "row" }}
                        >
                            {row.map((cell, colIndex) => (
                                <div
                                    key={colIndex}
                                    className="cell"
                                    onClick={() => handleMove(rowIndex, colIndex)}
                                    style={{
                                        ...cellStyle,
                                        display: "flex",
                                        justifyContent: "center",
                                    }}
                                >
                                    {renderCellContent(cell)}
                                </div>
                            ))}
                        </div>
                    ))}
                </div>
            </Grid>
        </div>
    );
}
